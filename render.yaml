# render.yaml
# Render.com ìë™ ë°°í¬ ì„¤ì • íŒŒì¼
# YouTube Translator FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ìš©

services:
  # ì›¹ ì„œë¹„ìŠ¤ ì •ì˜
  - type: web
    name: youtube-translator-kr  # ì„œë¹„ìŠ¤ ì´ë¦„ (URLì— í¬í•¨ë¨)
    runtime: python
    region: singapore  # í•œêµ­ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ë¦¬ì „
    plan: free  # ë¬´ë£Œ í”Œëœ (ì›” 750ì‹œê°„)
    
    # Python ë²„ì „ ì§€ì •
    pythonVersion: "3.11"
    
    # ë¹Œë“œ í•„í„° ì„¤ì • (ì„ íƒì‚¬í•­)
    buildFilter:
      paths:
        - app/**
        - requirements.txt
        - render.yaml
        - "*.py"
    
    # ë¹Œë“œ ëª…ë ¹ì–´
    buildCommand: |
      # ë¹Œë“œ ì‹œì‘ ë¡œê·¸
      echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘..."
      echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
      echo "ğŸ“‚ íŒŒì¼ ëª©ë¡:"
      ls -la
      
      # Python ë²„ì „ í™•ì¸
      echo "ğŸ Python ë²„ì „:"
      python --version
      
      # pip ì—…ê·¸ë ˆì´ë“œ
      echo "ğŸ“¦ pip ì—…ê·¸ë ˆì´ë“œ ì¤‘..."
      pip install --upgrade pip
      
      # ì˜ì¡´ì„± ì„¤ì¹˜
      echo "ğŸ“š íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
      pip install -r requirements.txt
      
      # gunicornê³¼ uvicorn worker ëª…ì‹œì  ì„¤ì¹˜ (í˜¹ì‹œ ëˆ„ë½ëœ ê²½ìš° ëŒ€ë¹„)
      pip install gunicorn uvicorn[standard]
      
      # ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
      echo "âœ… ì„¤ì¹˜ëœ ì£¼ìš” íŒ¨í‚¤ì§€:"
      pip show fastapi gunicorn uvicorn
      
      # í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸ (ë””ë²„ê¹…ìš©)
      echo "ğŸ” í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸:"
      if [ -d "app" ]; then
        echo "âœ“ app ë””ë ‰í† ë¦¬ ì¡´ì¬"
        ls -la app/
      else
        echo "âŒ app ë””ë ‰í† ë¦¬ ì—†ìŒ!"
      fi
      
      # main.py íŒŒì¼ í™•ì¸
      if [ -f "app/main.py" ]; then
        echo "âœ“ app/main.py íŒŒì¼ ì¡´ì¬"
      else
        echo "âŒ app/main.py íŒŒì¼ ì—†ìŒ!"
      fi
      
      echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
    
    # ì„œë²„ ì‹œì‘ ëª…ë ¹ì–´ (ì¤‘ìš”!)
    startCommand: |
      # ì„œë²„ ì‹œì‘ ì „ í™˜ê²½ í™•ì¸
      echo "ğŸš€ ì„œë²„ ì‹œì‘ ì¤€ë¹„..."
      echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
      echo "ğŸŒ í¬íŠ¸: $PORT"
      echo "ğŸ”§ í™˜ê²½: ${ENVIRONMENT:-production}"
      
      # gunicornìœ¼ë¡œ FastAPI ì•± ì‹¤í–‰
      # app.main:app = app ë””ë ‰í† ë¦¬ì˜ main.py íŒŒì¼ì—ì„œ app ë³€ìˆ˜
      exec gunicorn app.main:app \
        --bind 0.0.0.0:$PORT \
        --workers 1 \
        --worker-class uvicorn.workers.UvicornWorker \
        --worker-connections 1000 \
        --max-requests 1000 \
        --max-requests-jitter 50 \
        --timeout 30 \
        --graceful-timeout 30 \
        --keep-alive 5 \
        --access-logfile - \
        --error-logfile - \
        --log-level ${LOG_LEVEL:-info} \
        --capture-output \
        --enable-stdio-inheritance
    
    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    envVars:
      # Gemini API í‚¤ (Render ëŒ€ì‹œë³´ë“œì—ì„œ ì„¤ì •)
      - key: GEMINI_API_KEY
        sync: false  # ë³´ì•ˆì„ ìœ„í•´ ëŒ€ì‹œë³´ë“œì—ì„œ ìˆ˜ë™ ì…ë ¥
        
      # Python í™˜ê²½ ë³€ìˆ˜
      - key: PYTHON_VERSION
        value: "3.11"
        
      - key: PYTHONUNBUFFERED
        value: "1"  # ë¡œê·¸ ì‹¤ì‹œê°„ ì¶œë ¥
        
      # íƒ€ì„ì¡´ ì„¤ì • (í•œêµ­ ì‹œê°„)
      - key: TZ
        value: Asia/Seoul
        
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
      - key: ENVIRONMENT
        value: production
        
      - key: DEBUG
        value: "False"  # í”„ë¡œë•ì…˜ì—ì„œëŠ” False
        
      - key: LOG_LEVEL
        value: info
        
      # FastAPI ì„¤ì •
      - key: HOST
        value: "0.0.0.0"
        
      - key: PORT
        value: "10000"  # Renderì˜ ê¸°ë³¸ í¬íŠ¸
        
      # CORS ì„¤ì • (ë°°í¬ í›„ ì‹¤ì œ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
      - key: ALLOWED_ORIGINS
        value: "*"  # ì´ˆê¸°ì—ëŠ” ëª¨ë“  ë„ë©”ì¸ í—ˆìš©
      
      # ì„±ëŠ¥ ìµœì í™”
      - key: WEB_CONCURRENCY
        value: "1"  # ë¬´ë£Œ í”Œëœì—ì„œëŠ” 1ê°œ ì›Œì»¤ ê¶Œì¥
    
    # í—¬ìŠ¤ì²´í¬ ì„¤ì •
    healthCheckPath: /health
    healthCheckInterval: 300  # 5ë¶„ë§ˆë‹¤ ì²´í¬
    healthCheckTimeout: 10    # 10ì´ˆ íƒ€ì„ì•„ì›ƒ
    
    # ìë™ ë°°í¬ ì„¤ì •
    autoDeploy: true  # main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ìë™ ë°°í¬
    
    # ë¹Œë“œ í™˜ê²½ ë³€ìˆ˜
    buildEnvVars:
      - key: PYTHON_VERSION
        value: "3.11"
        
      - key: PIP_NO_CACHE_DIR
        value: "1"  # ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
