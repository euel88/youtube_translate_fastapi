# render.yaml
# Render.com 자동 배포 설정 파일
# FastAPI 애플리케이션을 위한 최적화된 설정

services:
  # 웹 서비스 정의
  - type: web
    name: youtube-translator-kr  # 서비스 이름 (URL에 포함됨)
    runtime: python
    region: singapore  # 한국에서 가장 가까운 리전
    plan: free  # 무료 플랜 (월 750시간)
    
    # Python 버전 명시적 지정
    buildFilter:
      paths:
        - app/**
        - requirements.txt
        - render.yaml
    
    # 빌드 설정
    buildCommand: |
      # Python 환경 설정
      echo "🔧 Python 버전 확인..."
      python --version
      
      # pip 업그레이드 및 패키지 설치
      echo "📦 패키지 설치 중..."
      pip install --upgrade pip
      pip install -r requirements.txt
      
      # gunicorn 설치 확인 (requirements.txt에 없을 경우 대비)
      pip install gunicorn
      
      # 프로젝트 구조 확인 (디버깅용)
      echo "📁 프로젝트 구조 확인..."
      ls -la
      ls -la app/
    
    # 서버 시작 명령어 (수정됨!)
    startCommand: |
      # ✅ gunicorn으로 FastAPI 앱 실행
      # app 디렉토리의 main.py 파일에서 app 객체를 찾습니다
      echo "🚀 서버 시작 중..."
      echo "포트: $PORT"
      gunicorn app.main:app \
        --bind 0.0.0.0:$PORT \
        --workers 1 \
        --worker-class uvicorn.workers.UvicornWorker \
        --timeout 120 \
        --access-logfile - \
        --error-logfile - \
        --log-level info
    
    # 환경 변수 설정
    envVars:
      # Gemini API 키 (Render 대시보드에서 설정)
      - key: GEMINI_API_KEY
        sync: false  # 보안을 위해 대시보드에서 수동 입력
        
      # Python 버전 지정 (3.11 권장)
      - key: PYTHON_VERSION
        value: "3.11"
        
      # 타임존 설정 (한국 시간)
      - key: TZ
        value: Asia/Seoul
        
      # 로그 레벨
      - key: LOG_LEVEL
        value: info
        
      # FastAPI 환경 설정
      - key: ENVIRONMENT
        value: production
        
      # CORS 설정 (배포 후 실제 도메인으로 변경 필요)
      - key: ALLOWED_ORIGINS
        value: "*"  # 초기에는 모든 도메인 허용
        
      # 워커 타임아웃 (초)
      - key: WORKER_TIMEOUT
        value: "120"
    
    # 헬스체크 설정
    healthCheckPath: /health
    healthCheckInterval: 300  # 5분마다 체크
    
    # 자동 배포 설정
    autoDeploy: true  # main 브랜치 푸시 시 자동 배포
    
    # 빌드 환경 설정
    buildEnvVars:
      - key: PYTHON_VERSION
        value: "3.11"
